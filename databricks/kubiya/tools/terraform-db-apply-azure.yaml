tools:
- name: azure-db-apply-tool
  image: hashicorp/terraform              
  description: "Create a databricks workspace."
  long_running: true
  type: docker
  alias: ter-az-apply
  content: |
    git clone -b "$BRANCH" https://"$PAT"@github.com/"$GIT_ORG"/"$GIT_REPO".git $DIR
    cd $DIR/aux/databricks/terraform/azure

    terraform init  -backend-config="storage_account_name=mytestbackendaccount" \
      -backend-config="container_name=mytestbackendblob" \
      -backend-config="key=databricks/{{ .workspace_name}}/terraform.tfstate" \
      -backend-config="resource_group_name=app-staging" \
      -backend-config="subscription_id=${ARM_SUBSCRIPTION_ID}"
    terraform apply -auto-approve \
      -var "WORKSPACE_NAME={{ .workspace_name }}" \
      -var "region={{ .region }}" \
      -var "managed_services_cmk_key_vault_key_id={{ .managed_services_cmk_key_vault_key_id }}" \
      -var "managed_disk_cmk_key_vault_key_id={{ .managed_disk_cmk_key_vault_key_id }}" \
      -var "infrastructure_encryption_enabled={{ .infrastructure_encryption_enabled }}" \
      -var "no_public_ip={{ .no_public_ip }}" \
      -var "enable_vnet={{ .enable_vnet }}" \
      -var "virtual_network_id={{ .virtual_network_id }}" \
      -var "private_subnet_name={{ .private_subnet_name }}" \
      -var "public_subnet_name={{ .public_subnet_name }}" \
      -var "public_subnet_network_security_group_association_id={{ .public_subnet_network_security_group_association_id }}" \
      -var "private_subnet_network_security_group_association_id={{ .private_subnet_network_security_group_association_id }}" \
      -var "storage_account_name={{ .storage_account_name }}" 
      
    echo "The state file can be found here: https://mytestbackendaccount.blob.core.windows.net/mytestbackendblob"      
    echo "The workspace can be found here: https://portal.azure.com/#@kubiya.ai/resource/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/databricks-{{ .workspace_name }}-rg/providers/Microsoft.Databricks/workspaces/databricks-{{ .workspace_name }}-workspace/overview"                             
    
  args:
    - name: "workspace_name"
      description: "The name of the databricks workspace."
      required: true
      
    - name: "region"
      description: "The azure region for the workspace."
      required: true

    - name: "managed_services_cmk_key_vault_key_id "
      description: "The ID of the key vault key to use for managed services encryption."
      required: false
      

    - name: "managed_disk_cmk_key_vault_key_id "
      description: "The ID of the key vault key to use for managed disk encryption."
      required: false
      

    - name: "infrastructure_encryption_enabled"
      description: "Enable infrastructure encryption, can be true or false."
      required: false
      default: false

    - name: "no_public_ip"
      description: "Secure cluster connectivity, no public ip, can be true or false."
      required: false
      default: false

    - name: "enable_vnet"
      description: "Enable custom vnet use, boolean, can be true or false."
      required: false
      default: false

    - name: "virtual_network_id"
      description: "The virtual network id."
      required: false

    - name: "private_subnet_name"
      description: "The name of the private subnet."
      required: false

    - name: "public_subnet_name"
      description: "The name of the public subnet."
      required: false  

    - name: "public_subnet_network_security_group_association_id"
      description: "The ID of the public subnet network security group association."
      required: false  

    - name: "private_subnet_network_security_group_association_id"
      description: "The ID of the private subnet network security group association."
      required: false  

    - name: "storage_account_name"
      description: "The name of the storage account."
      required: false  

  env:
    - "DB_ACCOUNT_ID"
    - "DB_ACCOUNT_CLIENT_ID"
    - "DB_ACCOUNT_CLIENT_SECRET"
    - "GIT_ORG"
    - "GIT_REPO"
    - "BRANCH"
    - "DIR"
    - "ARM_CLIENT_ID"
    - "ARM_CLIENT_SECRET"
    - "ARM_TENANT_ID"
    - "ARM_SUBSCRIPTION_ID"
    - "PAT"
